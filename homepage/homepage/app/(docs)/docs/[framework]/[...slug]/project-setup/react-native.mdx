export const metadata = { title: "React Native" };

import { CodeGroup } from "@/components/forMdx";

# React Native Installation and Setup

This guide covers setting up Jazz for React Native applications. If you're using Expo, please refer to the [React Native - Expo](/docs/react-native-expo/project-setup) guide instead.

Jazz supports the [New Architecture](https://reactnative.dev/architecture/landing-page) for React Native.

Tested with:

<CodeGroup>```json "react-native": "0.76.7", "react": "18.3.1" ```</CodeGroup>

## Setup

### Create a new project

(Skip this step if you already have one)

<CodeGroup>
  ```bash pnpx @react-native-community/cli init my-jazz-app cd my-jazz-app ```
</CodeGroup>

### Install dependencies

<CodeGroup>
```bash
# React Native dependencies
npm install @react-native-community/netinfo @bam.tech/react-native-image-resizer

# React Native polyfills

npm i -S @azure/core-asynciterator-polyfill react-native-url-polyfill readable-stream react-native-get-random-values @craftzdog/react-native-buffer @op-engineering/op-sqlite react-native-mmkv

# Jazz dependencies

npm i -S jazz-tools jazz-react-native jazz-react-native-media-images

````
</CodeGroup>

**Note**: Hermes has added support for `atob` and `btoa` in React Native 0.74. If you are using earlier versions, you may also need to polyfill `atob` and `btoa` in your `package.json`. Packages to try include `text-encoding` and `base-64`, and you can drop `@bacons/text-decoder`.

### Install CocoaPods

If you're compiling for iOS, you'll need to install CocoaPods for your project. We recommend using [`pod-install`](https://www.npmjs.com/package/pod-install):

<CodeGroup>
```bash
pnpm pods
````

</CodeGroup>

### Configure Metro

#### Regular repositories

If you are not working within a monorepo, create a new file `metro.config.js` in the root of your project with the following content:

<CodeGroup>
```ts
// metro.config.js
const {getDefaultConfig, mergeConfig} = require('@react-native/metro-config');

const config = {
  resolver: {
    sourceExts: ["mjs", "js", "json", "ts", "tsx"],
    requireCycleIgnorePatterns: [/(^|\/|\\)node_modules($|\/|\\)/]
  }
};

module.exports = mergeConfig(getDefaultConfig(__dirname), config);
```
</CodeGroup>

#### Monorepos

For monorepos, use the following `metro.config.js`:

<CodeGroup>
```ts
// metro.config.js
const path = require("path");
const { makeMetroConfig } = require("@rnx-kit/metro-config");
const MetroSymlinksResolver = require("@rnx-kit/metro-resolver-symlinks");

// Define workspace root
const projectRoot = __dirname;
const workspaceRoot = path.resolve(projectRoot, "../..");

// Add packages paths
const extraNodeModules = {
  modules: path.resolve(workspaceRoot, "node_modules"),
};

const watchFolders = [
  path.resolve(workspaceRoot, "node_modules"),
  path.resolve(workspaceRoot, "packages"),
];

const nodeModulesPaths = [
  path.resolve(projectRoot, "node_modules"),
  path.resolve(workspaceRoot, "node_modules"),
];

module.exports = makeMetroConfig({
  resolver: {
    resolveRequest: MetroSymlinksResolver(),
    extraNodeModules,
    nodeModulesPaths,
  },
  sourceExts: ["mjs", "js", "json", "ts", "tsx"],
  watchFolders,
});
````

</CodeGroup>

### Additional monorepo configuration (for pnpm)

- Add `node-linker=hoisted` to the root `.npmrc` (create this file if it doesn't exist).
- Add the following to the root `package.json`:

<CodeGroup>
```json
// package.json
"pnpm": {
  "peerDependencyRules": {
    "ignoreMissing": [
      "@babel/*",
      "typescript"
    ]
  }
}
```
</CodeGroup>

### Add polyfills

Create a file `polyfills.js` at the project root with the following content:

<CodeGroup>
```js
// polyfills.js
import { polyfillGlobal } from 'react-native/Libraries/Utilities/PolyfillFunctions';
import { Buffer } from "@craftzdog/react-native-buffer";
polyfillGlobal("Buffer", () => Buffer); // polyfill Buffer

import { ReadableStream } from "readable-stream";
polyfillGlobal("ReadableStream", () => ReadableStream); // polyfill ReadableStream

import "@azure/core-asynciterator-polyfill"; // polyfill Async Iterator
import "@bacons/text-decoder/install"; // polyfill Text Decoder
import 'react-native-get-random-values'; // polyfill getRandomValues
```
</CodeGroup>

Update `index.js`:

<CodeGroup>
```ts
// index.js
import {AppRegistry} from 'react-native';
import App from './App';
import {name as appName} from './app.json';
import './src/polyfills';

AppRegistry.registerComponent(appName, () => App);

````
</CodeGroup>

Lastly, ensure that the `"main"` field in your `package.json` points to `index.js`:

<CodeGroup>
```json
// package.json
{
  "main": "index.js",
  ...
}
````

</CodeGroup>

## Setting up the provider

Wrap your app components with the `<JazzProvider />` component:

<CodeGroup>
```tsx
// App.tsx
import { JazzProvider } from "jazz-react-native";
import { MyAppAccount } from "./schema";

export function MyJazzProvider({ children }: { children: React.ReactNode }) {
  return (
    <JazzProvider
      sync={{ peer: "wss://cloud.jazz.tools/?key=you@example.com" }}
      AccountSchema={MyAppAccount}
    >
      {children}
    </JazzProvider>
  );
}

// Register the Account schema so `useAccount` returns our custom `MyAppAccount`
declare module "jazz-react-native" {
interface Register {
Account: MyAppAccount;
}
}

````
</CodeGroup>

### Provider Options

- `kvStore`
  - `MMKVStoreAdapter` (default)
- `AccountSchema`
  - `Account` (default)
- `CryptoProvider`
  - `PureJSCrypto` (default) - Pure JavaScript crypto provider
  - `RNQuickCrypto` - C++ accelerated crypto provider

### Local Persistence

Jazz for React Native includes built-in local persistence using SQLite. This implementation uses:

- **Database Storage**: `@op-engineering/op-sqlite` - A high-performance SQLite implementation
- **Key-Value Storage**: `react-native-mmkv` - A fast key-value storage system

Local persistence is enabled by default with no additional configuration required. Your data will automatically persist across app restarts.

#### Advanced Configuration

You can customize the storage options in the `JazzProvider`:

<CodeGroup>
```tsx
// App.tsx
import {
  JazzProvider,
  OpSQLiteAdapter,
  MMKVStoreAdapter,
} from "jazz-react-native";

// Default configuration - no parameters needed
<JazzProvider
  sync={{ peer: "wss://cloud.jazz.tools/?key=you@example.com" }}
  AccountSchema={MyAppAccount}
>
  {children}
</JazzProvider>

// Or with explicit configuration
<JazzProvider
  storage="sqlite" // Use default OpSQLiteAdapter
  // Or with custom configuration
  // storage={{
  //   adapter: new OpSQLiteAdapter({ /* custom options */ }),
  //   kvStore: new MMKVStoreAdapter({ /* custom options */ })
  // }}
  sync={{ peer: "wss://cloud.jazz.tools/?key=you@example.com" }}
  AccountSchema={MyAppAccount}
>
  {children}
</JazzProvider>
````

</CodeGroup>

### Choosing an auth method

Refer to the Jazz + React Native demo projects for implementing authentication:

- [DemoAuth Example](https://github.com/garden-co/jazz/tree/main/examples/chat-rn)

In the demos, you'll find details on:

- Using JazzProvider with your chosen authentication method
- Defining a Jazz schema
- Creating and subscribing to covalues
- Handling invites

### Working with Images

Jazz provides a complete solution for handling images in React Native, including uploading, processing, and displaying them. Here's how to work with images:

#### Uploading Images

To upload images, use the `createImage` function from `jazz-react-native-media-images`. This function handles image processing and creates an `ImageDefinition` that can be stored in your Jazz covalues:

<CodeGroup>
```tsx
import { createImage } from "jazz-react-native-media-images";
import * as ImagePicker from 'react-native-image-picker';

// Example: Image upload from device library
const handleImageUpload = async () => {
try {
const result = await ImagePicker.launchImageLibrary({
mediaTypes: ImagePicker.MediaTypeOptions.Images,
base64: true, // Important: We need base64 data
quality: 0.7,
});

    if (!result.canceled && result.assets[0].base64) {
      const base64Uri = `data:image/jpeg;base64,${result.assets[0].base64}`;

      const image = await createImage(base64Uri, {
        owner: someCovalue._owner,  // Set appropriate owner
        maxSize: 2048,  // Optional: limit maximum image size
      });

      // Store the image in your covalue
      someCovalue.image = image;
    }

} catch (error) {
console.error('Failed to upload image:', error);
}
};

````
</CodeGroup>

#### Displaying Images

To display images, use the `ProgressiveImg` component from `jazz-react-native`. This component handles both images uploaded from React Native and desktop browsers:

<CodeGroup>
```tsx
import { ProgressiveImg } from "jazz-react-native";
import { Image } from "react-native";

// Inside your render function:
<ProgressiveImg image={someCovalue.image} targetWidth={1024}>
  {({ src, res, originalSize }) => (
    <Image
      source={{ uri: src }}
      style={{
        width: 300,  // Adjust size as needed
        height: 300,
        borderRadius: 8,
      }}
      resizeMode="cover"
    />
  )}
</ProgressiveImg>
````

</CodeGroup>

The `ProgressiveImg` component:

- Automatically handles different image formats
- Provides progressive loading with placeholder images
- Supports different resolutions based on the `targetWidth` prop
- Works seamlessly with React Native's `Image` component

For a complete implementation example, see the [Chat Example](https://github.com/garden-co/jazz/blob/main/examples/chat-rn-expo-clerk/app/chat/[chatId].tsx).

### Running your app

<CodeGroup>
```sh
pnpm i
pnpm pods
pnpm ios

# or

pnpm i
pnpm android

```
</CodeGroup>
```
