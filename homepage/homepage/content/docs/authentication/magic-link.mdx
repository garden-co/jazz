export const metadata = { title: "Magic Link Authentication" };

import { CodeGroup, ContentByFramework } from "@/components/forMdx";

# Magic Link Authentication

Magic Links can be used to transfer authentication from one device to another, for example using a QR code.

## How it works

Magic Link auth supports two flows, where **Desktop** refers to the device that creates and displays the QR code, and **Mobile** refers to the device that scans and handles it:

- **Mobile to Desktop**: Mobile scans the QR code to authenticate the desktop device
- **Desktop to Mobile**: Mobile scans the QR to authenticate itself

Once the QR code has been scanned, the already-authenticated device (source) shows a 6-digit code that the user should enter on the device trying to authenticate (target).

If the confirmation code is correct, the source device reveals the secret, and the target device uses it to authenticate.

## Key benefits

- **Portable**: Apps using passkey auth for example can use magic links to authenticate devices where the passkey is not available
- **User-friendly**: Users familiar with WhatsApp, Discord, etc. already know how this works

## Implementation

### Mobile to Desktop

We start by creating a link on the **Desktop** device using `useCreateMagicLinkAuth` as `target`, and handling the flow's `status`:

<ContentByFramework framework="react">
<CodeGroup>
```tsx twoslash
import { useCreateMagicLinkAuth } from "jazz-react";
import React, { useState } from "react";
interface CreateMagicLinkAsTargetProps {
  onLoggedIn: () => void;
}
const QRCode = (_: { url: string }) => (<></>)
const ConfirmationCodeForm = (_: { onSubmit: (code: string) => void}) => (<></>)


// ---cut---
export function CreateMagicLinkAsTarget({
  onLoggedIn,
}: CreateMagicLinkAsTargetProps) {
  const [link, setLink] = useState<string | undefined>();

  const { status, createLink, sendConfirmationCode } = useCreateMagicLinkAuth({
    as: "target",
    onLoggedIn,
  });

  const onCreateLink = () => createLink().then(setLink);

  if (status === "idle") {
    return (
      <button onClick={onCreateLink}>
        Create QR code
      </button>
    );
  }

  if (status === "waitingForHandler") {
    return (
      <>
        <p>Scan QR code to log in</p>
        {link ? <QRCode url={link} /> : null}
      </>
    );
  }

  if (status === "confirmationCodeRequired") {
    return (
      <>
        <p>Enter the confirmation code displayed on your other device</p>
        {sendConfirmationCode ? (
          <ConfirmationCodeForm onSubmit={sendConfirmationCode} />
        ) : null}
      </>
    );
  }

  if (status === "confirmationCodePending") {
    return <p>Confirming...</p>;
  }

  if (status === "authorized") {
    return <p>Logged in!</p>;
  }

  if (status === "confirmationCodeIncorrect") {
    return (
      <>
        <p>Incorrect confirmation code!</p>
        <button onClick={onCreateLink}>Try again</button>
      </>
    );
  }

  if (status === "error") {
    return (
      <>
        <p>Something went wrong</p>
        <button onClick={onCreateLink}>Try again</button>
      </>
    );
  }

  if (status === "cancelled") {
    return (
      <>
        <p>Cancelled</p>
        <button onClick={onCreateLink}>Try again</button>
      </>
    );
  }
}
```
</CodeGroup>

On the **Mobile** side, we need to host a page at `/magic-link-handler-source`, or provide an alternative handler path to the hooks using the `sourceHandlerPath` option.

This is the page we'll land on when the QR code is scanned, handling the magic link with the `useHandleMagicLinkAuth` hook as `source`, and using `status` to display the current state:

<CodeGroup>
```tsx twoslash
import React from "react";
import { useHandleMagicLinkAuth } from "jazz-react";

// ---cut---
export function HandleMagicLinkAsSource() {
  const { status, confirmationCode } = useHandleMagicLinkAuth({
    as: "source",
  });

  if (status === "idle") {
    return <p>Loading...</p>;
  }

  if (status === "confirmationCodeGenerated") {
    return (
      <p>Confirmation code: {confirmationCode}</p>
    );
  }

  if (status === "authorized") {
    return (
      <p>Your device has been logged in!</p>
    );
  }

  if (status === "confirmationCodeIncorrect") {
    return (
      <p>Incorrect confirmation code - please try again</p>
    );
  }

  if (status === "error") {
    return (
      <p>Something went wrong</p>
    );
  }

  if (status === "cancelled") {
    return <p>Login cancelled</p>;
  }
}
```
</CodeGroup>

### Desktop to Mobile

This is similar to the **Mobile to Desktop** flow, but the roles are reversed: `useCreateMagicLinkAuth` on the **Desktop** device should be used as `source`, and `useHandleMagicLinkAuth` on the **Mobile** device should be used as `target`.

On the **Desktop** device:

<CodeGroup>
```tsx twoslash
import React, { useState } from "react";
import { useCreateMagicLinkAuth } from "jazz-react";
const QRCode = (_: { url: string }) => (<></>)

// ---cut---
export function CreateMagicLinkAsSource() {
  const [link, setLink] = useState<string | undefined>();

  const { status, createLink, confirmationCode } = useCreateMagicLinkAuth({
    as: "source",
  });

  const onCreateLink = () => createLink().then(setLink);

  if (status === "idle") {
    return (
      <button color="primary" onClick={onCreateLink}>
        Create QR code
      </button>
    );
  }

  if (status === "waitingForHandler") {
    return (
      <>
        <p>Scan QR code to get your device logged in</p>
        {link ? <QRCode url={link} /> : null}
      </>
    );
  }

  if (status === "confirmationCodeGenerated") {
    return <p>Confirmation code: {confirmationCode}</p>;
  }

  if (status === "confirmationCodeCorrect") {
    return <p>Confirmed! Logging in...</p>;
  }

  if (status === "authorized") {
    return <p>Your device has been logged in!</p>;
  }

  if (status === "confirmationCodeIncorrect") {
    return (
      <>
        <p>Incorrect confirmation code</p>
        <button onClick={onCreateLink}>Try again</button>
      </>
    );
  }

  if (status === "error") {
    return (
      <>
        <p>Something went wrong</p>
        <button onClick={onCreateLink}>Try again</button>
      </>
    );
  }

  if (status === "cancelled") {
    return (
      <>
        <p>Login cancelled</p>
        <button onClick={onCreateLink}>Try again</button>
      </>
    );
  }
}
```
</CodeGroup>

On the **Mobile** device we need to host a page at `/magic-link-handler-target`, or provide an alternative handler path to the hooks using the `targetHandlerPath` option.

This is the page we'll land on when the QR code is scanned, handling the magic link with the `useHandleMagicLinkAuth` hook as `target`, and using `status` to display the current state:

<CodeGroup>
```tsx twoslash
import React from "react";
import { useHandleMagicLinkAuth } from "jazz-react";
const ConfirmationCodeForm = (_: { onSubmit: (code: string) => void}) => (<></>)

// ---cut---
export function HandleMagicLinkAsTarget() {
  const { status, sendConfirmationCode } = useHandleMagicLinkAuth({
    as: "target",
    targetHandlerPath: "/#/magic-link-handler-target",
    sourceHandlerPath: "/#/magic-link-handler-source",
    onLoggedIn: () => {
      console.log("logged in!");
    },
  });

  if (status === "idle") {
    return <p>Loading...</p>;
  }

  if (status === "confirmationCodeRequired") {
    return (
      <>
        <p>Enter the confirmation code displayed on your other device</p>

        {sendConfirmationCode ? (
          <ConfirmationCodeForm onSubmit={sendConfirmationCode} />
        ) : null}
      </>
    );
  }

  if (status === "confirmationCodePending") {
    return <p>Confirming...</p>;
  }

  if (status === "authorized") {
    return <p>Logged in!</p>;
  }

  if (status === "confirmationCodeIncorrect") {
    return (
      <p>Incorrect confirmation code - please try again</p>
    );
  }

  if (status === "error") {
    return <p>Something went wrong</p>;
  }

  if (status === "cancelled") {
    return <p>Login cancelled</p>;
  }
}
```
</CodeGroup>
</ContentByFramework>

## Examples

You can try Magic Link authentication using our [magic link example](https://magic-link.jazz.tools/).

## When to use Magic Links

Magic Link authentication is ideal when:

- You need a fallback authentication method alongside passkeys
- Your app is designed to be used on mobile devices

## Limitations and considerations

- **No revocation**: Once the secret has been shared with the target device, it cannot be revoked
- **Requires a camera**: The Magic Link handler needs to have a camera to scan the QR code, or another way to get the link
