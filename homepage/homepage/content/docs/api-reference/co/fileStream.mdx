import { CodeGroup } from '@/components/forMdx';
import EnsureLoaded from './snippets/EnsureLoaded.mdx';
import JazzDefaultProperties from './snippets/JazzDefaultProperties.mdx';
import SubscribeInstance from './snippets/SubscribeInstance.mdx';
import SubscribeStatic from './snippets/SubscribeStatic.mdx';
import WaitForSync from './snippets/WaitForSync.mdx';
export const metadata = {
  description: "API reference for the `co.fileStream` module.",
};

# FileStream

`co.fileStream` provides core functionalities for creating and managing collaborative file streams (binary data storage) in Jazz applications. FileStreams are the collaborative equivalent of `Blob`s or `File`s.

See the [detailed guide](/docs/core-concepts/covalues/filestreams).

## `FileStream` Class

<CodeGroup preferWrap>
```ts
class FileStream extends CoValueBase implements CoValue
```
</CodeGroup>

Extends `CoValueBase` and implements `CoValue`. Represents a collaborative binary file stream.

FileStreams are `CoFeed`-based structures that contain binary data, allowing you to store and sync files like images, videos, PDFs, or any other binary content in your Jazz application.

### Declaration

`FileStream` can be referenced in schemas:

{/* TODO: Extract snippet */}
<CodeGroup preferWrap>
```ts
import { co, FileStream } from "jazz-tools";

const Document = co.map({
  title: z.string(),
  file: FileStream,
});
```
</CodeGroup>

### Static Methods

#### `create`

<CodeGroup preferWrap>
```ts
static create<S extends FileStream>(
  this: CoValueClass<S>,
  options?: { owner?: Account | Group } | Account | Group,
): S
```
</CodeGroup>

**Usage:** Use `co.fileStream().create`.

Creates a new empty `FileStream` instance.

- `options`: (Optional) Configuration options for the new FileStream.
  - `owner`: The Account or Group that will own this FileStream and control access rights.

**Returns:** A newly created `FileStream` instance.

{/* TODO: Extract snippet */}
**Example:**
<CodeGroup preferWrap>
```ts
// Create owned by an account
const stream = FileStream.create({ owner: myAccount });

// Create owned by a group
const stream = FileStream.create({ owner: teamGroup });

// Create with implicit owner
const stream = FileStream.create(myAccount);
```
</CodeGroup>

**Remarks:** For uploading an existing file or blob, use [`FileStream.createFromBlob()`](#createfromblob) instead.

#### `createFromBlob`
<CodeGroup preferWrap>
```ts
static async createFromBlob(
  blob: Blob | File,
  options?: {
    owner?: Account | Group;
    onProgress?: (progress: number) => void;
  } | Account | Group,
): Promise<FileStream>
```
</CodeGroup>

**Usage:** Use `co.fileStream().createFromBlob`.

Creates a `FileStream` from a `Blob` or `File`.

- `blob`: The `Blob` or `File` to upload.
- `options`: (Optional) Configuration options.
  - `owner`: The Account or Group that will own this FileStream.
  - `onProgress`: A callback function that receives progress updates (0 to 1).

**Returns:** A promise that resolves to the newly created `FileStream`.

**Example:**
{/* TODO: Extract snippet */}
<CodeGroup preferWrap>
```ts
import { FileStream } from "jazz-tools";

// From a file input
const fileInput = document.querySelector('input[type="file"]');
const file = fileInput.files[0];
const fileStream = await FileStream.createFromBlob(file, {
  owner: group,
  onProgress: (progress) => {
    console.log(`Upload progress: ${Math.round(progress * 100)}%`);
  }
});
```
</CodeGroup>

#### `createFromArrayBuffer`

<CodeGroup preferWrap>
```ts
static async createFromArrayBuffer(
  arrayBuffer: ArrayBuffer,
  mimeType: string,
  fileName: string | undefined,
  options?: {
    owner?: Account | Group;
    onProgress?: (progress: number) => void;
  } | Account | Group,
): Promise<FileStream>
```
</CodeGroup>

**Usage:** Use `co.fileStream().createFromArrayBuffer`.

Creates a `FileStream` from an `ArrayBuffer`.

- `arrayBuffer`: The binary data as an `ArrayBuffer`.
- `mimeType`: The MIME type of the file (e.g., `"image/png"`).
- `fileName`: (Optional) The name of the file.
- `options`: (Optional) Configuration options.
  - `owner`: The Account or Group that will own this FileStream.
  - `onProgress`: A callback function that receives progress updates (0 to 1).

**Returns:** A promise that resolves to the newly created `FileStream`.

#### `load`

<CodeGroup preferWrap>
```ts
static async load<C extends FileStream>(
  this: CoValueClass<C>,
  id: ID<C>,
  options?: {
    loadAs?: Account | AnonymousJazzAgent;
    allowUnfinished?: boolean;
  },
): Promise<Settled<FileStream>>
```
</CodeGroup>

**Usage:** Use `co.fileStream().load`.

Loads a `FileStream` by its ID.

By default, waits for the stream to be complete before resolving. Use `allowUnfinished: true` to load incomplete streams.

- `id`: The `ID` of the `FileStream` to load.
- `options`: (Optional) An object containing:
  - `loadAs`: The `Account` or `AnonymousJazzAgent` to load as.
  - `allowUnfinished`: Whether to return incomplete streams.

**Returns:** A promise that resolves to the loaded `FileStream`.

#### `subscribe`

<CodeGroup preferWrap>
```typescript
static subscribe<F extends FileStream, const R extends RefsToResolve<F>>(
  this: CoValueClass<F>,
  id: ID<F>,
  listener: (value: Resolved<F, R>, unsubscribe: () => void) => void,
): () => void;
static subscribe<F extends FileStream, const R extends RefsToResolve<F>>(
  this: CoValueClass<F>,
  id: ID<F>,
  options: SubscribeListenerOptions<F, R>,
  listener: (value: Resolved<F, R>, unsubscribe: () => void) => void,
): () => void;
```
</CodeGroup>

**Usage:** Use `co.fileStream().subscribe`.

<SubscribeStatic item="FileStream" />

#### `loadAsBlob`

<CodeGroup preferWrap>
```ts
static async loadAsBlob(
  id: ID<FileStream>,
  options?: {
    allowUnfinished?: boolean;
    loadAs?: Account | AnonymousJazzAgent;
  },
): Promise<Blob | undefined>
```
</CodeGroup>

**Usage:** Use `co.fileStream().loadAsBlob`.

Loads a `FileStream` as a `Blob`.

- `id`: The `ID` of the `FileStream` to load.
- `options`: (Optional) An object containing:
  - `allowUnfinished`: Whether to return incomplete blobs.
  - `loadAs`: The `Account` or `AnonymousJazzAgent` to load as.

**Returns:** A promise that resolves to a `Blob`, or `undefined` if not available.

#### `loadAsBase64`

<CodeGroup preferWrap>
```ts
static async loadAsBase64(
  id: ID<FileStream>,
  options?: {
    allowUnfinished?: boolean;
    loadAs?: Account | AnonymousJazzAgent;
    dataURL?: boolean;
  },
): Promise<string | undefined>
```
</CodeGroup>

Loads a `FileStream` as a base64-encoded string.

- `id`: The `ID` of the `FileStream` to load.
- `options`: (Optional) An object containing:
  - `allowUnfinished`: Whether to return incomplete data.
  - `loadAs`: The `Account` or `AnonymousJazzAgent` to load as.
  - `dataURL`: Whether to return as a data URL (with MIME type prefix).

**Returns:** A promise that resolves to a base64 string, or `undefined` if not available.

### Instance Methods

#### `getMetadata`

<CodeGroup preferWrap>
```ts
getMetadata(): BinaryStreamInfo | undefined
```
</CodeGroup>

Gets the metadata of this FileStream.

**Returns:** An object containing:
- `mimeType`: The MIME type of the file
- `totalSizeBytes`: The total size in bytes
- `fileName`: (Optional) The file name

Or `undefined` if metadata is not available.

#### `getChunks`

<CodeGroup preferWrap>
```ts
getChunks(options?: {
  allowUnfinished?: boolean;
}): (BinaryStreamInfo & { chunks: Uint8Array[]; finished: boolean }) | undefined
```
</CodeGroup>

Gets the binary chunks of this FileStream.

- `options`: (Optional) An object containing:
  - `allowUnfinished`: Whether to return incomplete chunks.

**Returns:** An object containing metadata, chunks array, and finished status, or `undefined` if not available.

#### `isBinaryStreamEnded`

<CodeGroup preferWrap>
```ts
isBinaryStreamEnded(): boolean
```
</CodeGroup>

Checks if the binary stream has been completely uploaded.

**Returns:** `true` if the stream is complete, `false` otherwise.

#### `toBlob`

<CodeGroup preferWrap>
```ts
toBlob(options?: { allowUnfinished?: boolean }): Blob | undefined
```
</CodeGroup>

Converts this FileStream to a `Blob`.

- `options`: (Optional) An object containing:
  - `allowUnfinished`: Whether to return incomplete blobs.

**Returns:** A `Blob`, or `undefined` if not available.

**Example:**

<CodeGroup preferWrap>
```ts
const blob = fileStream.toBlob();
if (blob) {
  const url = URL.createObjectURL(blob);
  // Use url for downloading, displaying, etc.
}
```
</CodeGroup>

#### `asBase64`

<CodeGroup preferWrap>
```ts
asBase64(options?: {
  allowUnfinished?: boolean;
  dataURL?: boolean;
}): string | undefined
```
</CodeGroup>

Converts this FileStream to a base64-encoded string.

- `options`: (Optional) An object containing:
  - `allowUnfinished`: Whether to return incomplete data.
  - `dataURL`: Whether to return as a data URL (with MIME type prefix).

**Returns:** A base64 string, or `undefined` if not available.

**Example:**
<CodeGroup preferWrap>
```ts
// Get base64 string
const base64 = fileStream.asBase64();

// Get data URL for images
const dataUrl = fileStream.asBase64({ dataURL: true });
imageElement.src = dataUrl;
```
</CodeGroup>

#### `start`

<CodeGroup preferWrap>
```ts
start(options: BinaryStreamInfo): void
```
</CodeGroup>

Starts a binary stream with metadata. Use this for manual streaming.

- `options`: Metadata for the stream:
  - `mimeType`: The MIME type
  - `totalSizeBytes`: The total size in bytes
  - `fileName`: (Optional) The file name

#### `push`

<CodeGroup preferWrap>
```ts
push(data: Uint8Array): void
```
</CodeGroup>

Pushes a chunk of binary data to the stream.

- `data`: The binary data chunk.

#### `end`

<CodeGroup preferWrap>
  ```ts
end(): void
```
</CodeGroup>

Ends the binary stream, marking it as complete.

#### `toJSON`
<CodeGroup preferWrap>
```ts
toJSON(): {
  $jazz: { id: string };
  mimeType?: string;
  totalSizeBytes?: number;
  fileName?: string;
  chunks?: Uint8Array[];
  finished?: boolean;
}
```
</CodeGroup>

Gets a JSON representation of the `FileStream`.

**Returns:** An object with metadata and chunk information.

## $jazz

```typescript
class FileStreamJazzApi<F extends FileStream> extends CoValueJazzApi<F>
```

Provides Jazz-specific methods and properties for a `FileStream` instance, accessed via the `$jazz` property on a `FileStream`.

### Properties

<JazzDefaultProperties />

### Methods

#### `$jazz.ensureLoaded`
<EnsureLoaded />

#### `$jazz.subscribe`
<SubscribeInstance item='FileStream' />

#### `$jazz.waitForSync`
<WaitForSync />
