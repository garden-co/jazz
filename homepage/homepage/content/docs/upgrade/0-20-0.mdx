import { Alert, CodeGroup } from '@/components/forMdx'

# Jazz 0.20.0 - Full native crypto

With this release, we complete our migration to a pure **native** Rust toolchain.
We have removed the JavaScript compatibility layer, meaning our native Rust core now runs everywhere: React Native, Edge runtimes, all server-side environments, and the web.

## Motivation

Before 0.20.0, Jazz relied on a JavaScript crypto implementation to work around compatibility issues in some runtimes-most notably React Native.
As a result, our native Rust core wasn’t running in React Native and, on some Edge runtimes, 
only worked when WASM was explicitly initialized (see [WASM on Edge runtimes](/docs/react/server-side/setup#wasm-on-edge-runtimes)).

The JavaScript crypto implementation is much slower than native Rust crypto. Although workarounds like RNQuickCrypto for React Native improved performance, they still only wrapped certain native libraries, rather than running Jazz's full Rust crypto.

With native Rust crypto now running everywhere, Jazz comes with good performance in every platform. 
This also helps us speed up the migration of Jazz Core to Rust which will help us improve the Jazz overall performance.

## What changed

- We dropped support for `PureJSCrypto`. Jazz crypto now runs natively in each environment.
- We dropped support for `RNQuickCrypto`. RNCrypto is now the default crypto provider on React Native.
- There is no more fallback to Javascript crypto. If the crypto fails to initialize, it will throw an error. 
**NB**: if you use WASM crypto on Edge runtimes, you need to ensure that WASM is available and initialized. See more details at [WASM on Edge runtimes](/docs/react/server-side/setup#wasm-on-edge-runtimes).
- We have restricted the type of [unique](/docs/react/core-concepts/covalues/comaps#uniqueness) to make the cross-language serialization more deterministic. You can now pass only strings or records of strings as unique params. 

## Breaking changes

### A more strict `unique` param

Jazz uses [uniqueness](/docs/react/core-concepts/covalues/comaps#uniqueness) to help identify CoValues. 

Occasionally, you may wish to produce a deterministic ID for the CoValue. To do so, you can manually define the uniqueness using the [`unique`](/docs/react/core-concepts/covalues/comaps#uniqueness) parameter.
Before 0.20.0, you could pass any `JsonValue` as unique param. This was not stable across languages and could lead to unexpected behavior.

The `unique` property now enforces strict type validation, limiting inputs to specific primitives rather than generic `JsonValue` types.
Accepted types are `string`, `boolean`, `null`, `undefined`, or objects containing `string` values.

Providing any other type will throw an error, with the following distinction for numbers:
- Floating-point numbers (e.g., `1.5`) will throw an error.
- Integers (e.g., `1`) are accepted and will not throw an error, though their usage is deprecated and not supported in the type system anymore.

We expect that this change **will not impact** any projects in our hosted Cloud based on our analysis.
However, since we do **not have visibility into self-hosted sync server deployments**, we cannot rule out the possibility that your code may rely on the previously allowed unique value types.

If you are migrating from an earlier version and your project passes type-checks, you are almost certainly unaffected.  
If you do encounter issues (for example, errors about unsupported `unique` value types), 
the recommended upgrade path is to convert your uniqueness constraint to a string (as shown below), or, if necessary, to an object containing only string properties.

**If you are affected by this change and cannot migrate to a supported unique type, please [reach us on Discord](https://discord.gg/ANm5jY6Y) for help or guidance.**

Below is an example showing a correct migration:
<CodeGroup>
```ts
// Before (may throw an error in 0.20.0 if a non-string/object-of-string unique is used)
Task.create({ text: "X" }, { unique: 123 }); // NOT SUPPORTED

// After (convert to string or object with string values)
Task.create({ text: "X" }, { unique: "123" }); // SUPPORTED
// OR
// @ts-expect-error - We are bypassing the type check
Task.create({ text: "X" }, { unique: 123 }); // SUPPORTED
```
</CodeGroup>

### Edge runtimes

If you use WASM crypto on Edge runtimes, you need to ensure that WASM is available and initialized, there is no more fallback to Javascript crypto. 
See more details at [WASM on Edge runtimes](/docs/react/server-side/setup#wasm-on-edge-runtimes).

<CodeGroup>
```ts
import "jazz-tools/load-edge-wasm";
// Other Jazz Imports

export default {
  async fetch(request: Request, env: Env, ctx: ExecutionContext) {
    // Jazz application logic
    return new Response("Hello from Jazz on Cloudflare!");
  },
};
```
</CodeGroup>

if you don't do this, you will get an error like this:

<CodeGroup>
```
Critical Error: Failed to load WASM module

You need to add \`import "jazz-tools/load-edge-wasm";\` on top 
of your entry module to make Jazz work with this runtime 

A native crypto module is required for Jazz to work. 
See https://jazz.tools/docs/react/reference/performance#use-the-best-crypto-implementation-for-your-platform 
for possible alternatives.
```
</CodeGroup>

Before 0.20.0, you would get a warning like this:
<CodeGroup>
```
Warning: WASM crypto is not available. Falling back to JavaScript crypto.
```
</CodeGroup>

### Expo

If you had previously installed QuickCrypto, then you should follow the steps below. Otherwise, no action is needed to take advantage of RNCrypto!

1) **Remove QuickCrypto dependencies/config** (only if you previously added them for `RNQuickCrypto`):

- Remove `react-native-quick-crypto` (and any associated config you added for it).
- Remove any `SODIUM_ENABLED` / `sodiumEnabled` settings you added specifically for QuickCrypto.

2) **Remove `CryptoProvider` entirely** (RNCrypto is now the default)

You have to remove the `CryptoProvider` option, it is no longer supported:

<CodeGroup>
```tsx
import { JazzExpoProvider } from "jazz-tools/expo";
import { MyAppAccount } from "./schema";

const apiKey = "you@example.com";

export function MyJazzProvider({ children }: { children: React.ReactNode }) {
  return (
    <JazzExpoProvider
      sync={{ peer: `wss://cloud.jazz.tools/?key=${apiKey}` }}
      AccountSchema={MyAppAccount}
    >
      {children}
    </JazzExpoProvider>
  );
}
```
</CodeGroup>

<Alert variant="warning" title="Versioning" className="mt-4">
  While you can distribute your own JS code changes OTA, if you update your Jazz version, this will result in changes in the native dependencies, which *cannot* be distributed over the air and requires a new store submission.
</Alert>

### React Native (non-Expo)

If you use React Native, you need to install `cojson-core-rn` and make sure the version matches `jazz-tools`. `cojson-core-rn` is our new high-performance crypto provider for React Native, 
and it is **required** for React Native applications.

1) **Install `cojson-core-rn` (required)** and make sure the version matches `jazz-tools`:

<CodeGroup className="mb-4">
```bash
npm install cojson-core-rn
```
</CodeGroup>

<CodeGroup>
```json
"dependencies": {
  "cojson-core-rn": "x.x.x", # same version as jazz-tools
  "jazz-tools": "x.x.x" # same version as cojson-core-rn
}
```
</CodeGroup>

<Alert variant="warning" title="Versioning" className="mt-4">
  While you can distribute your own JS code changes OTA, if you update your Jazz version, this will result in changes in the native dependencies, which *cannot* be distributed over the air and requires a new store submission.
</Alert>

See also: [React Native setup](/docs/react-native/project-setup).

2) **Remove QuickCrypto dependencies/config** (only if you previously added them for `RNQuickCrypto`):

- Remove `react-native-quick-crypto` (and any associated config you added for it).
- Remove any `SODIUM_ENABLED` / `sodiumEnabled` settings you added specifically for QuickCrypto.

3) **Remove `CryptoProvider` entirely** (RNCrypto is now the default)

After installing `cojson-core-rn`, you have to remove the `CryptoProvider` option, it is no longer supported:

<CodeGroup>
```tsx
import { JazzReactNativeProvider } from "jazz-tools/react-native";
import { MyAppAccount } from "./schema";

const apiKey = "you@example.com";

export function MyJazzProvider({ children }: { children: React.ReactNode }) {
  return (
    <JazzReactNativeProvider
      sync={{ peer: `wss://cloud.jazz.tools/?key=${apiKey}` }}
      AccountSchema={MyAppAccount}
    >
      {children}
    </JazzReactNativeProvider>
  );
}
```
</CodeGroup>
